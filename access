#!/bin/sh
# Access Eternal - Minimal POSIX dynamic DNS
set -e

# Set LIB if it doesn't exist
if [ -z "$LIB" ]; then
    LIB="/usr/local/lib/access"
fi

# Initialize essential variables and functions (without root check for ip command)
command="${1:-help}"
if [ "$command" = "ip" ] || [ "$command" = "help" ]; then
    # Skip root check for ip and help commands
    CONFIG="/etc/access/config.env"
    BIN="/usr/local/bin/access"
    LIB="/usr/local/lib/access"
    STATE="/var/lib/access"
    [ -f "$CONFIG" ] && . "$CONFIG"
elif [ -f "$LIB/init.sh" ]; then
    . "$LIB/init.sh"
fi

# Handle commands
command="${1:-help}"
[ "$command" = "" ] && command="help"

if [ -f "$LIB/$command.sh" ]; then
    sh "$LIB/$command.sh" "$@"
elif [ -f "$LIB/module/$command.sh" ]; then
    module_file="$LIB/module/$command.sh"
    . "$module_file"
    if command -v "main" >/dev/null 2>&1; then
        main "$@"
    else
        printf "Error: Function main not found in module %s\n" "$command"
        exit 1
    fi
else
    printf "Error: Module %s not found\n" "$command"
    exit 1
fi