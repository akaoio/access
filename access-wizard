#!/bin/sh
# Access Configuration Wizard
# Provides easy management of Access configuration including optional scan feature

set -e

SCRIPT_DIR="$(dirname "$0")"

# Load wizard functionality
if [ -f "$SCRIPT_DIR/lib/access-wizard.sh" ]; then
    . "$SCRIPT_DIR/lib/access-wizard.sh"
else
    echo "Error: Wizard functionality not found"
    echo "Please ensure lib/access-wizard.sh exists"
    exit 1
fi

# Command handling
case "${1:-}" in
    reconfigure|config)
        wizard_reconfigure
        ;;
    scan)
        case "${2:-}" in
            enable)
                wizard_enable_scan
                ;;
            disable)
                wizard_disable_scan
                ;;
            toggle)
                wizard_toggle_scan
                ;;
            setup)
                wizard_setup_scan_interactive
                ;;
            *)
                wizard_configure_scan
                ;;
        esac
        ;;
    automation)
        wizard_configure_automation
        ;;
    interval)
        wizard_configure_interval
        ;;
    auto-update)
        wizard_configure_auto_update
        ;;
    apply|apply-changes)
        wizard_apply_changes
        ;;
    status|show)
        wizard_status
        ;;
    toggle-scan)
        wizard_toggle_scan
        ;;
    full|interactive)
        if [ -x "$SCRIPT_DIR/interactive-install.sh" ]; then
            exec "$SCRIPT_DIR/interactive-install.sh"
        else
            echo "Error: Interactive installer not found"
            exit 1
        fi
        ;;
    help|--help|-h)
        cat << 'EOF'
Access Configuration Wizard

USAGE:
  access-wizard [COMMAND] [OPTIONS]

COMMANDS:
  (no command)       Interactive configuration menu
  reconfigure        Change individual settings
  scan               Configure scan/peer discovery feature
  automation         Change automation method
  interval           Change update interval
  auto-update        Configure automatic updates
  toggle-scan        Quick enable/disable scan feature
  apply              Apply pending configuration changes
  status             Show current configuration
  full               Run full interactive installation wizard
  help               Show this help message

SCAN FEATURE COMMANDS:
  access-wizard scan                # Configure scan feature
  access-wizard scan enable         # Enable scan feature
  access-wizard scan disable        # Disable scan feature  
  access-wizard scan toggle         # Toggle scan on/off
  access-wizard scan setup          # Interactive scan setup

EXAMPLES:
  access-wizard                     # Interactive menu
  access-wizard reconfigure         # Change specific settings
  access-wizard scan disable        # Disable scan feature
  access-wizard toggle-scan         # Quick scan toggle
  access-wizard status              # Show current config
  access-wizard apply               # Apply changes

CONFIGURATION FILES:
  ~/.config/access/wizard.json      # Wizard configuration
  ~/.config/access/scan.json        # Scan configuration (if enabled)
  ~/.config/access/config.json      # Main Access configuration

The scan/peer discovery feature is completely OPTIONAL and can be
enabled or disabled at any time without affecting basic Access functionality.

EOF
        exit 0
        ;;
    "")
        # Interactive menu - default behavior
        echo "Access Configuration Wizard"
        echo ""
        
        # Show current status first
        wizard_status
        
        echo "Configuration Options:"
        echo "1) Reconfigure specific settings"
        echo "2) Configure scan/peer discovery feature"
        echo "3) Toggle scan feature on/off"
        echo "4) Run full interactive installation"
        echo "5) Apply pending changes"
        echo "0) Exit"
        echo ""
        
        printf "Choose option [0-5]: "
        read -r choice
        
        case "$choice" in
            1)
                wizard_reconfigure
                ;;
            2)
                wizard_configure_scan
                ;;
            3)
                wizard_toggle_scan
                ;;
            4)
                if [ -x "$SCRIPT_DIR/interactive-install.sh" ]; then
                    exec "$SCRIPT_DIR/interactive-install.sh"
                else
                    echo "Interactive installer not found"
                    exit 1
                fi
                ;;
            5)
                wizard_apply_changes
                ;;
            0|"")
                echo "Goodbye!"
                exit 0
                ;;
            *)
                echo "Invalid choice"
                exit 1
                ;;
        esac
        ;;
    *)
        echo "Unknown command: $1"
        echo "Run 'access-wizard help' for usage information"
        exit 1
        ;;
esac